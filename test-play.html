<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Knobly | Secure Exam Mode</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          fontFamily: {
            sans: ["Outfit", "system-ui", "sans-serif"],
          },
          colors: {
            knobly: {
              bg: "#020617",
              panel: "rgba(15,23,42,0.96)",
              neon: "#22c55e",
              neonSoft: "rgba(34,197,94,0.2)",
              blue: "#38bdf8",
            },
          },
          boxShadow: {
            "k-glow": "0 0 40px rgba(56,189,248,0.45)",
            "k-neon": "0 0 40px rgba(34,197,94,0.45)",
            "k-red": "0 0 32px rgba(248,113,113,0.6)",
          },
          backgroundImage: {
            "k-grid":
              "radial-gradient(circle at 1px 1px, rgba(148,163,184,0.22) 1px, transparent 0)",
          },
          animation: {
            "drop-pulse": "drop-shine 4s infinite ease-in-out",
          },
          keyframes: {
            "drop-shine": {
              "0%, 100%": {
                borderColor: "rgba(255, 255, 255, 0.1)",
                boxShadow: "inset 0 0 10px rgba(255,255,255,0.05)",
              },
              "50%": {
                borderColor: "rgba(255, 255, 255, 0.4)",
                boxShadow: "inset 0 0 15px rgba(56,189,248,0.3)",
              },
            },
          },
        },
      },
    };
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />

  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <style>
    :root {
      color-scheme: dark;
    }

    body {
      font-family: "Outfit", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: #020617;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.6) transparent;
    }

    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    *::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }
  </style>
</head>

<body class="min-h-screen text-slate-100 overflow-x-hidden selection:bg-rose-500/30 selection:text-rose-200">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950"></div>
    <div class="absolute inset-0 bg-k-grid bg-[size:42px_42px] opacity-[0.32] mix-blend-soft-light"></div>
    <div class="absolute -top-24 -left-10 h-72 w-72 bg-sky-500/25 blur-3xl rounded-full"></div>
    <div class="absolute -bottom-28 -right-12 h-80 w-80 bg-rose-500/25 blur-3xl rounded-full"></div>
  </div>

  <!-- Center warning -->
  <div id="warningCenter"
    class="fixed inset-0 z-[60] hidden items-center justify-center bg-slate-950/80 backdrop-blur-md px-4 cursor-pointer"
    title="Click anywhere to return to exam">
    <div
      class="w-full max-w-sm rounded-3xl border border-rose-400/80 bg-gradient-to-br from-rose-900 via-slate-950 to-rose-900 shadow-k-red px-5 py-6 flex flex-col items-center text-center transform scale-90">
      <div class="flex items-center justify-center gap-2 mb-3">
        <div class="h-10 w-10 rounded-full bg-rose-500/20 flex items-center justify-center animate-pulse">
          <i class="ph ph-warning-octagon text-3xl text-rose-400"></i>
        </div>
      </div>
      <h3 class="text-sm uppercase tracking-[0.2em] text-rose-300 font-bold mb-1">
        Security Breach
      </h3>
      <p id="warningMainText" class="text-lg font-semibold text-white mb-1">
        Suspicious action detected
      </p>
      <p id="warningSubText" class="text-xs text-rose-200/80 max-w-[250px] leading-relaxed">
        Do not copy content, switch tabs, or exit fullscreen.
      </p>

      <div class="mt-4 w-full h-1 bg-slate-800 rounded-full overflow-hidden">
        <div id="warningProgress" class="h-full bg-rose-500 w-full origin-left"></div>
      </div>

      <p id="warningCounterText" class="mt-3 text-[11px] font-mono text-rose-400">
        Warning 1 of 3
      </p>
    </div>
  </div>

  <!-- Confirm overlay -->
  <div id="confirmOverlay"
    class="fixed inset-0 z-[70] hidden items-center justify-center bg-slate-950/80 backdrop-blur-sm px-4">
    <div
      class="w-full max-w-xs sm:max-w-sm rounded-3xl border border-white/10 bg-slate-900 shadow-2xl shadow-sky-900/40 p-5 transform transition-all">
      <div class="flex flex-col items-center text-center gap-3">
        <div class="h-12 w-12 rounded-2xl bg-slate-800 flex items-center justify-center border border-slate-700">
          <i class="ph ph-question text-2xl text-sky-400"></i>
        </div>

        <div>
          <h3 id="confirmTitle" class="text-base font-semibold text-white">
            Confirm Action
          </h3>
          <p id="confirmText" class="text-xs text-slate-400 mt-1">
            Are you sure you want to proceed?
          </p>
        </div>

        <div class="grid grid-cols-2 gap-3 w-full mt-2">
          <button id="confirmCancelBtn"
            class="w-full py-2 rounded-xl border border-slate-700 bg-slate-800 text-slate-300 text-xs font-medium hover:bg-slate-700 transition">
            Cancel
          </button>
          <button id="confirmYesBtn"
            class="w-full py-2 rounded-xl border border-sky-500/50 bg-sky-500/20 text-sky-100 text-xs font-medium hover:bg-sky-500/30 transition shadow-lg shadow-sky-500/10">
            Yes, Proceed
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile drawer -->
  <div id="mobileDrawer" class="fixed inset-0 z-50 hidden lg:hidden">
    <div id="mobileDrawerOverlay" class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm opacity-0"></div>

    <div id="mobileDrawerPanel"
      class="absolute right-0 top-0 bottom-0 w-[85%] max-w-[320px] bg-slate-900 border-l border-white/10 shadow-2xl shadow-black flex flex-col translate-x-full">
      <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between bg-slate-950">
        <h2 class="text-sm font-semibold flex items-center gap-2">
          <i class="ph ph-squares-four text-sky-400"></i>
          Palette & Info
        </h2>
        <button id="closeDrawerBtn"
          class="h-8 w-8 rounded-full bg-slate-800 flex items-center justify-center text-slate-300 hover:text-white">
          <i class="ph ph-x"></i>
        </button>
      </div>

      <div class="flex-1 overflow-y-auto p-4 space-y-6">
        <div>
          <div class="flex items-center justify-between mb-3">
            <span class="text-xs font-medium text-slate-400 uppercase tracking-wider">Questions</span>
          </div>
          <div id="mobilePaletteContainer" class="grid grid-cols-5 gap-2"></div>
        </div>

        <div class="bg-slate-800/50 rounded-xl p-3 border border-white/5 space-y-2 text-[11px]">
          <div class="flex items-center gap-2">
            <span class="h-2.5 w-2.5 rounded-full bg-emerald-500"></span>
            <span class="text-slate-300">Answered</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="h-2.5 w-2.5 rounded-full bg-amber-500"></span>
            <span class="text-slate-300">Visited</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="h-2.5 w-2.5 rounded-full bg-sky-500"></span>
            <span class="text-slate-300">Current</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="h-2.5 w-2.5 rounded-full bg-slate-600"></span>
            <span class="text-slate-400">Not Visited</span>
          </div>
        </div>

        <div>
          <span class="text-xs font-medium text-rose-400 uppercase tracking-wider block mb-2">Security Status</span>
          <div class="bg-rose-500/10 border border-rose-500/20 rounded-xl p-3">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs text-rose-200">Warnings Issued</span>
              <span id="mobileWarningCount" class="text-sm font-bold text-rose-400">0 / 3</span>
            </div>
            <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
              <div id="mobileWarningBar" class="h-full bg-rose-500 w-0 transition-all duration-300"></div>
            </div>
            <p class="text-[10px] text-rose-300/70 mt-2 leading-tight">
              If you reach 3 warnings (copying, tab switching, or fullscreen
              exit), the exam will auto-submit.
            </p>
          </div>
        </div>
      </div>

      <div class="p-4 border-t border-white/10 bg-slate-950 flex flex-col gap-2">
        <p class="text-[10px] text-slate-500 text-center mb-1">
          Use the top button to submit.
        </p>
        <button id="mobileDrawerBackBtn"
          class="w-full py-2.5 rounded-xl bg-slate-800 border border-slate-700 text-slate-300 text-xs font-medium flex items-center justify-center gap-2 hover:bg-slate-700 active:scale-95 transition">
          <i class="ph ph-arrow-u-up-left text-sm"></i>
          Back to Dashboard
        </button>
      </div>
    </div>
  </div>

  <!-- Result Overlay -->
  <div id="resultOverlay"
    class="fixed inset-0 z-[80] hidden bg-slate-950/95 backdrop-blur-md flex items-center justify-center px-3 sm:px-5 py-4">
    <div
      class="w-full max-w-2xl max-h-[90vh] rounded-3xl border border-white/15 bg-slate-900/95 shadow-2xl shadow-emerald-500/40 overflow-hidden flex flex-col">
      <header class="px-5 py-4 border-b border-white/10 flex items-center justify-between gap-3 bg-slate-950/95">
        <div class="flex items-center gap-3">
          <div
            class="h-10 w-10 rounded-2xl bg-gradient-to-br from-emerald-400 to-sky-400 flex items-center justify-center text-slate-950 font-semibold shadow-k-neon text-lg">
            K
          </div>
          <div class="leading-tight">
            <h2 class="text-lg font-semibold flex items-center gap-2">
              Exam Submitted
            </h2>
            <p class="text-[11px] text-slate-400">
              Your results are ready.
            </p>
          </div>
        </div>
      </header>

      <main class="flex-1 p-5 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent">
        <div class="flex flex-col gap-5">
          <div class="rounded-2xl border border-white/12 bg-slate-950/50 px-4 py-4">
            <h3 class="text-sm font-semibold flex items-center gap-2 mb-3">
              <i class="ph ph-chart-bar text-lg text-sky-300"></i>
              Performance Summary
            </h3>
            <div id="resultSummary" class="grid grid-cols-2 gap-3 text-xs"></div>
          </div>

          <div class="flex flex-col gap-3">
            <button id="reviewPageBtn"
              class="w-full py-3 rounded-xl bg-sky-500/20 border border-sky-500/50 text-sky-100 font-medium flex items-center justify-center gap-2 hover:bg-sky-500/30 transition shadow-lg shadow-sky-500/10">
              <i class="ph ph-list-magnifying-glass text-lg"></i>
              Review Full Analysis & Answers
            </button>

            <button id="resultBackBtn"
              class="w-full py-3 rounded-xl bg-slate-800 border border-slate-700 text-slate-300 font-medium flex items-center justify-center gap-2 hover:bg-slate-700 transition">
              <i class="ph ph-house text-lg"></i>
              Back to Dashboard
            </button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Start overlay -->
  <div id="startOverlay"
    class="fixed inset-0 z-30 flex items-center justify-center bg-slate-950/90 backdrop-blur-xl px-4">
    <div class="w-full max-w-md rounded-3xl border border-white/15 bg-slate-950/95 p-5 shadow-2xl shadow-sky-500/40">
      <div class="flex items-center gap-3 mb-3">
        <div
          class="h-10 w-10 rounded-2xl bg-gradient-to-br from-sky-400 to-emerald-400 flex items-center justify-center text-slate-950 font-semibold shadow-k-neon">
          K
        </div>
        <div class="leading-tight">
          <h2 class="text-lg font-semibold text-white">
            Secure Exam Mode
          </h2>
          <p class="text-[11px] text-slate-400">
            Strict anti-cheat protocols are active.
          </p>
        </div>
      </div>

      <div class="bg-rose-500/10 border border-rose-500/30 rounded-xl p-3 mb-4">
        <ul class="text-[11px] text-rose-100 space-y-2">
          <li class="flex items-start gap-2">
            <i class="ph ph-prohibit text-sm text-rose-400 mt-0.5"></i>
            <span><strong>Right click & Copy</strong> are disabled.</span>
          </li>
          <li class="flex items-start gap-2">
            <i class="ph ph-arrows-out-simple text-sm text-rose-400 mt-0.5"></i>
            <span><strong>Exiting fullscreen</strong> triggers a
              warning.</span>
          </li>
          <li class="flex items-start gap-2">
            <i class="ph ph-browsers text-sm text-rose-400 mt-0.5"></i>
            <span><strong>Switching tabs</strong> triggers a warning.</span>
          </li>
        </ul>
      </div>

      <button id="startExamBtn"
        class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl border border-sky-400/80 bg-sky-500/20 text-[13px] text-sky-50 hover:bg-sky-500/30 active:scale-[0.97] transition font-semibold tracking-wide shadow-lg shadow-sky-500/20">
        <i class="ph ph-play-circle text-lg"></i>
        Enter Fullscreen & Start
      </button>

      <p class="mt-3 text-center text-[10px] text-slate-500">
        By clicking Start, you agree to the monitoring rules.
      </p>
    </div>
  </div>

  <!-- Main exam shell -->
  <div class="min-h-screen flex items-center justify-center px-2 sm:px-5 py-2 sm:py-4">
    <div
      class="w-full max-w-6xl max-h-[96vh] sm:max-h-[94vh] rounded-[20px] sm:rounded-[26px] border border-white/15 bg-slate-900/95 backdrop-blur-2xl shadow-2xl shadow-sky-500/40 flex flex-col overflow-hidden">
      <header
        class="flex items-center justify-between gap-2 sm:gap-3 px-3 sm:px-5 py-2 sm:py-2.5 border-b border-white/10 bg-slate-950/95">
        <div class="flex items-center gap-2 sm:gap-3 min-w-0">
          <div class="hidden sm:flex items-center gap-1.5">
            <span class="h-2.5 w-2.5 rounded-full bg-rose-500/80"></span>
            <span class="h-2.5 w-2.5 rounded-full bg-amber-400/80"></span>
            <span class="h-2.5 w-2.5 rounded-full bg-emerald-400/80"></span>
          </div>
          <div class="h-7 w-px bg-slate-700/70 mx-1 hidden sm:block"></div>

          <div class="flex items-center gap-2 min-w-0">
            <div
              class="h-7 w-7 sm:h-8 sm:w-8 rounded-xl sm:rounded-2xl bg-gradient-to-br from-sky-400 to-emerald-400 flex items-center justify-center text-slate-950 font-semibold text-sm sm:text-lg shadow-k-neon flex-shrink-0">
              K
            </div>
            <div class="leading-tight min-w-0">
              <div class="flex items-center gap-2 min-w-0">
                <h1 id="testTitle"
                  class="truncate max-w-[120px] sm:max-w-xs text-[13px] sm:text-base font-semibold tracking-tight">
                  Loading exam…
                </h1>
                <span id="trackBadge"
                  class="hidden sm:inline-flex items-center px-2 py-0.5 rounded-full text-[10px] border border-sky-400/60 bg-slate-900/90 text-sky-200 uppercase tracking-[0.16em]">
                  Track
                </span>
              </div>
              <p class="hidden sm:block text-[11px] text-slate-400">
                Secure exam · Autosave · Score based Points
              </p>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
          <div class="hidden md:flex flex-col items-end text-[10px] leading-tight">
            <span class="inline-flex items-center gap-1 text-slate-300">
              <i class="ph ph-shield-check text-xs text-emerald-300"></i>
              Anti-cheat active
            </span>
            <span id="warningCounter" class="text-slate-500">
              Warnings: 0 / 3
            </span>
          </div>

          <div
            class="flex items-center gap-2 rounded-xl sm:rounded-2xl border border-sky-400/70 bg-sky-500/15 px-2.5 sm:px-3 py-1 sm:py-1.5 shadow-k-glow min-w-[90px] sm:min-w-[110px]">
            <div class="flex flex-col items-end leading-tight w-full">
              <span class="text-[9px] sm:text-[10px] uppercase tracking-[0.1em] text-sky-200">
                Time left
              </span>
              <span id="timerDisplay" class="text-base sm:text-xl font-semibold tabular-nums text-white">
                --:--
              </span>
            </div>
            <span
              class="h-6 w-6 sm:h-7 sm:w-7 rounded-full border border-sky-300/80 flex items-center justify-center flex-shrink-0">
              <span class="h-2.5 w-2.5 sm:h-3 sm:w-3 rounded-full bg-emerald-400 animate-pulse"></span>
            </span>
          </div>

          <button id="submitBtn"
            class="inline-flex items-center gap-1.5 px-3.5 py-1.5 rounded-2xl text-[11px] font-medium border border-rose-400/80 bg-rose-500/20 text-rose-50 hover:bg-rose-500/30 active:scale-[0.97] transition">
            <i class="ph ph-check-circle text-xs"></i>
            Submit
          </button>
        </div>
      </header>

      <!-- Content -->
      <main class="flex-1 flex flex-col lg:flex-row gap-3 sm:gap-4 p-2 sm:p-4 lg:p-5 overflow-hidden">
        <!-- Left: question -->
        <section class="w-full lg:w-[65%] flex flex-col gap-3 sm:gap-4 overflow-hidden h-full">
          <div
            class="flex-shrink-0 rounded-2xl border border-white/12 bg-slate-950/95 px-3 sm:px-4 py-2 sm:py-3 flex items-center justify-between gap-3 shadow-lg shadow-slate-950/70">
            <div class="flex items-center gap-2 sm:gap-3">
              <div
                class="h-8 w-8 sm:h-9 sm:w-9 rounded-xl sm:rounded-2xl bg-gradient-to-br from-sky-500/25 to-emerald-400/40 flex items-center justify-center text-sky-100 border border-sky-400/70">
                <i class="ph ph-target text-lg"></i>
              </div>
              <div>
                <div id="questionProgress" class="text-xs sm:text-sm font-medium text-slate-100">
                  Loading…
                </div>
                <div class="text-[10px] text-slate-400 mt-0.5">
                  <span id="answeredCounter">0</span>
                  <span>/</span>
                  <span id="totalCounter">0</span>
                  <span>answered</span>
                </div>
              </div>
            </div>
          </div>

          <div id="questionCard"
            class="flex-1 min-h-0 rounded-2xl border border-white/12 bg-slate-950/95 px-3.5 sm:px-5 py-4 sm:py-5 shadow-xl shadow-slate-950/80 overflow-y-auto flex flex-col">
            <div class="flex items-start justify-between gap-2 flex-shrink-0">
              <div>
                <div id="questionBadge"
                  class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-[10px] bg-slate-900 border border-slate-700 text-slate-300 uppercase tracking-[0.16em]">
                  Question 1
                </div>
                <h2 id="questionTitle" class="mt-2 text-[14px] sm:text-[16px] font-semibold leading-snug text-sky-100">
                  Loading question…
                </h2>
              </div>
              <div class="flex flex-col items-end text-[10px] text-slate-400 flex-shrink-0">
                <span id="marksBadge"
                  class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 text-slate-200">
                  <i class="ph ph-star text-[11px] text-amber-300"></i>
                  <span id="marksLabel">— marks</span>
                </span>
              </div>
            </div>

            <p id="questionText" class="mt-3 text-[13px] sm:text-[14px] leading-relaxed text-slate-300 flex-shrink-0">
              —
            </p>

            <div id="optionsContainer" class="mt-4 space-y-2.5 pb-2"></div>

            <div id="shortContainer" class="mt-4 hidden pb-2">
              <label class="text-[11px] text-slate-400 mb-1 inline-flex items-center gap-1">
                <i class="ph ph-pencil-line text-xs"></i>
                Short answer
              </label>
              <textarea id="shortInput" rows="3"
                class="w-full rounded-2xl bg-slate-900/80 border border-slate-700/90 px-3 py-2.5 text-[13px] outline-none focus:border-sky-400/80 text-white placeholder-slate-600"
                placeholder="Type your answer here..."></textarea>
            </div>

            <div class="flex-1"></div>

            <div class="mt-4 flex-shrink-0 flex items-center justify-between gap-3 pt-3 border-t border-slate-800/80">
              <button id="prevBtn"
                class="inline-flex items-center gap-1.5 px-3.5 py-2 rounded-xl border border-slate-700 bg-slate-900/80 text-[12px] text-slate-200 hover:bg-slate-800 active:scale-[0.97] transition">
                <i class="ph ph-arrow-left text-xs"></i>
                Previous
              </button>
              <span id="currentIndexLabel" class="text-[11px] text-slate-400 font-mono">
                Q 1
              </span>
              <button id="nextBtn"
                class="inline-flex items-center gap-1.5 px-3.5 py-2 rounded-xl border border-sky-400/80 bg-sky-500/20 text-[12px] text-sky-50 hover:bg-sky-500/30 active:scale-[0.97] transition">
                <span id="nextBtnText">Next</span>
                <i id="nextBtnIcon" class="ph ph-arrow-right text-xs"></i>
              </button>
            </div>
          </div>
        </section>

        <!-- Right: palette -->
        <aside class="hidden lg:flex w-full lg:w-[35%] flex-col gap-3 sm:gap-4 overflow-hidden h-full">
          <div
            class="rounded-2xl border border-white/12 bg-slate-950/95 px-3.5 sm:px-4 py-3.5 flex flex-col shadow-lg shadow-slate-950/80 flex-1 min-h-0 overflow-hidden">
            <div class="flex items-center justify-between mb-2 flex-shrink-0">
              <div class="flex items-center gap-2">
                <i class="ph ph-squares-four text-lg text-sky-300"></i>
                <h3 class="text-sm font-semibold tracking-tight">
                  Question palette
                </h3>
              </div>
            </div>
            <div class="overflow-y-auto flex-1 pr-1">
              <div id="paletteContainer" class="mt-1 grid grid-cols-5 xl:grid-cols-6 gap-1.5 text-[11px]"></div>
            </div>

            <div
              class="mt-3 flex-shrink-0 grid grid-cols-2 gap-2 text-[10px] text-slate-400 border-t border-slate-800/80 pt-2">
              <div class="flex items-center gap-1">
                <span class="h-3 w-3 rounded-md bg-emerald-500/80"></span>
                <span>Answered</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="h-3 w-3 rounded-md bg-amber-400/80"></span>
                <span>Visited</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="h-3 w-3 rounded-md bg-sky-500/80"></span>
                <span>Current</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="h-3 w-3 rounded-md bg-slate-700"></span>
                <span>Not visited</span>
              </div>
            </div>
          </div>

          <div
            class="flex-shrink-0 rounded-2xl border border-white/12 bg-slate-950/95 px-3.5 sm:px-4 py-3.5 flex flex-col gap-3 shadow-lg shadow-slate-950/80 text-[11px]">
            <div class="flex items-center gap-2">
              <i class="ph ph-shield-warning text-lg text-emerald-300"></i>
              <p class="text-slate-300 leading-snug">
                <strong>Anti-cheat enabled:</strong> Copy, Paste, Tab
                Switch, and Fullscreen exit are monitored.
              </p>
            </div>
            <button id="backBtn"
              class="inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-xl border border-slate-700 bg-slate-900 hover:bg-slate-800 text-[11px] text-slate-200 active:scale-[0.97] transition">
              <i class="ph ph-arrow-bend-up-left text-xs"></i>
              Back to Dashboard
            </button>
          </div>
        </aside>
      </main>
    </div>
  </div>

  <!-- Mobile floating trigger (Vue mounts here) -->
  <div id="mobileTriggerApp" class="lg:hidden hidden"></div>

  <!-- JS -->
  <script type="module">
    import { createApp } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js"; // Use CDN for Vue
    import { auth, db } from "./firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      collection, doc, getDoc, getDocs, setDoc, updateDoc, addDoc, query, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ---------- GLOBAL STATE ----------
    let user = null;
    let testId = null;
    let testData = null;
    let questions = [];
    let attempt = null;

    let responsesMap = {};
    let visitedSet = new Set();

    let currentIndex = 0;
    let deadline = null;
    let timerInterval = null;

    let examStarted = false;
    let examFinished = false;

    let warningCount = 0;
    const MAX_WARNINGS = 3;

    // ---------- DOM ELEMENTS ----------
    const startOverlay = document.getElementById("startOverlay");
    const startExamBtn = document.getElementById("startExamBtn");

    const testTitleEl = document.getElementById("testTitle");
    const trackBadgeEl = document.getElementById("trackBadge");
    const timerDisplay = document.getElementById("timerDisplay");
    const warningCounterEl = document.getElementById("warningCounter");

    const questionProgressEl = document.getElementById("questionProgress");
    const answeredCounterEl = document.getElementById("answeredCounter");
    const totalCounterEl = document.getElementById("totalCounter");
    const questionBadgeEl = document.getElementById("questionBadge");
    const questionTitleEl = document.getElementById("questionTitle");
    const questionTextEl = document.getElementById("questionText");
    const marksLabelEl = document.getElementById("marksLabel");
    const optionsContainer = document.getElementById("optionsContainer");
    const shortContainer = document.getElementById("shortContainer");
    const shortInput = document.getElementById("shortInput");
    const paletteContainer = document.getElementById("paletteContainer");
    const currentIndexLabel = document.getElementById("currentIndexLabel");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const nextBtnText = document.getElementById("nextBtnText");
    const nextBtnIcon = document.getElementById("nextBtnIcon");
    const submitBtn = document.getElementById("submitBtn");

    const mobileDrawer = document.getElementById("mobileDrawer");
    const mobileDrawerPanel = document.getElementById("mobileDrawerPanel");
    const mobileDrawerOverlay = document.getElementById("mobileDrawerOverlay");
    const closeDrawerBtn = document.getElementById("closeDrawerBtn");
    const mobilePaletteContainer = document.getElementById("mobilePaletteContainer");
    const mobileWarningCount = document.getElementById("mobileWarningCount");
    const mobileWarningBar = document.getElementById("mobileWarningBar");
    const mobileTriggerApp = document.getElementById("mobileTriggerApp");
    const mobileDrawerBackBtn = document.getElementById("mobileDrawerBackBtn");

    const backBtn = document.getElementById("backBtn");

    const warningCenter = document.getElementById("warningCenter");
    const warningMainText = document.getElementById("warningMainText");
    const warningSubText = document.getElementById("warningSubText");
    const warningCounterText = document.getElementById("warningCounterText");
    const warningProgress = document.getElementById("warningProgress");

    const confirmOverlay = document.getElementById("confirmOverlay");
    const confirmTitle = document.getElementById("confirmTitle");
    const confirmText = document.getElementById("confirmText");
    const confirmYesBtn = document.getElementById("confirmYesBtn");
    const confirmCancelBtn = document.getElementById("confirmCancelBtn");
    let onConfirmAction = null;

    const resultOverlay = document.getElementById("resultOverlay");
    const resultSummary = document.getElementById("resultSummary");
    const resultBackBtn = document.getElementById("resultBackBtn");
    const reviewPageBtn = document.getElementById("reviewPageBtn");

    // ---------- BASIC HELPERS ----------
    document.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      return false;
    });

    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function formatTimer(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function countAnswered() {
      return Object.values(responsesMap).filter(
        (r) =>
          r &&
          (r.option_id ||
            (r.short_answer && r.short_answer.toString().trim() !== ""))
      ).length;
    }

    function updateWarningUI() {
      warningCounterEl.textContent = `Warnings: ${warningCount} / ${MAX_WARNINGS}`;
      warningCounterEl.className = "text-slate-500";
      if (warningCount === 1) {
        warningCounterEl.classList.add("text-amber-400", "font-bold");
      } else if (warningCount === 2) {
        warningCounterEl.classList.add("text-rose-400", "font-bold");
      } else if (warningCount >= 3) {
        warningCounterEl.classList.add("text-rose-500", "font-bold");
      }

      mobileWarningCount.textContent = `${warningCount} / ${MAX_WARNINGS}`;
      const pct = (warningCount / MAX_WARNINGS) * 100;
      mobileWarningBar.style.width = `${pct}%`;
    }

    // ---------- CONFIRM UI ----------
    function showCustomConfirm(title, message, callback) {
      confirmTitle.textContent = title;
      confirmText.textContent = message;
      onConfirmAction = callback;

      confirmOverlay.classList.remove("hidden");
      confirmOverlay.classList.add("flex");

      const box = confirmOverlay.querySelector("div");
      gsap.fromTo(
        box,
        { scale: 0.9, opacity: 0 },
        { scale: 1, opacity: 1, duration: 0.2, ease: "power2.out" }
      );
    }

    function hideCustomConfirm() {
      const box = confirmOverlay.querySelector("div");
      gsap.to(box, {
        scale: 0.95,
        opacity: 0,
        duration: 0.15,
        onComplete: () => {
          confirmOverlay.classList.add("hidden");
          confirmOverlay.classList.remove("flex");
        },
      });
    }

    confirmYesBtn.addEventListener("click", () => {
      if (onConfirmAction) onConfirmAction();
      hideCustomConfirm();
    });

    confirmCancelBtn.addEventListener("click", () => {
      hideCustomConfirm();
    });

    // ---------- MOBILE DRAWER ----------
    function openMobileDrawer() {
      if (!examStarted || examFinished) return;
      mobileDrawer.classList.remove("hidden");
      gsap.to(mobileDrawerOverlay, { opacity: 1, duration: 0.3 });
      gsap.to(mobileDrawerPanel, {
        x: "0%",
        duration: 0.3,
        ease: "power2.out",
      });
    }
    window.openMobileDrawer = openMobileDrawer;

    function closeMobileDrawer() {
      gsap.to(mobileDrawerOverlay, { opacity: 0, duration: 0.2 });
      gsap.to(mobileDrawerPanel, {
        x: "100%",
        duration: 0.2,
        ease: "power2.in",
        onComplete: () => {
          mobileDrawer.classList.add("hidden");
        },
      });
    }

    closeDrawerBtn.addEventListener("click", closeMobileDrawer);
    mobileDrawerOverlay.addEventListener("click", closeMobileDrawer);

    mobileDrawerBackBtn.addEventListener("click", () => {
      closeMobileDrawer();
      showCustomConfirm(
        "Exit Exam?",
        "The exam is still running. If you leave now, your progress will be saved but the timer continues.",
        () => {
          window.location.href = "dashboard.html";
        }
      );
    });

    // ---------- FLOATING BUTTON (Vue) ----------
    createApp({
      template: `
      <div 
        @click="openMobileDrawer" 
        class="fixed top-1/2 -translate-y-1/2 right-0 z-40 h-16 w-8 bg-white/10 backdrop-blur-md border border-white/20 border-r-0 flex items-center justify-center shadow-lg active:scale-95 transition-all duration-300 animate-drop-pulse cursor-pointer group rounded-l-[50px] rounded-br-none"
        title="Open Palette"
      >
        <i class="ph ph-caret-left text-xl text-white group-hover:text-sky-300 ml-1"></i>
      </div>
    `,
      methods: {
        openMobileDrawer() {
          if (window.openMobileDrawer) window.openMobileDrawer();
        },
      },
    }).mount("#mobileTriggerApp");

    // ---------- WARNING UI ----------
    function showCenterWarning(main, sub, isFullscreenError = false) {
      warningMainText.textContent = main;
      warningSubText.textContent = sub;
      warningCounterText.textContent = `Warning ${warningCount} of ${MAX_WARNINGS}`;

      warningCenter.style.display = "flex";
      const box = warningCenter.querySelector("div");

      gsap.fromTo(
        box,
        { opacity: 0, scale: 0.8 },
        { opacity: 1, scale: 1, duration: 0.4, ease: "back.out(1.7)" }
      );

      gsap.fromTo(
        warningProgress,
        { scaleX: 1 },
        { scaleX: 0, duration: 5, ease: "linear" }
      );

      if (isFullscreenError) {
        try {
          document.documentElement.requestFullscreen().catch(() => { });
        } catch (e) { }
        const restoreFs = () => {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(() => { });
          }
          document.removeEventListener("click", restoreFs);
          warningCenter.removeEventListener("click", restoreFs);
        };
        setTimeout(() => {
          document.addEventListener("click", restoreFs, { once: true });
          warningCenter.addEventListener("click", restoreFs, { once: true });
        }, 100);
      }

      setTimeout(() => {
        gsap.to(box, {
          opacity: 0,
          scale: 0.85,
          duration: 0.3,
          ease: "power2.in",
          onComplete: () => {
            warningCenter.style.display = "none";
            box.style.opacity = "";
            box.style.transform = "";
          },
        });
      }, 5000);
    }

    async function logProctor(eventType, details) {
      if (!attempt || !user) return;
      try {
        await addDoc(collection(db, "exam_proctor_log"), {
          attempt_id: attempt.id,
          user_id: user.uid,
          event_type: eventType,
          details,
          created_at: serverTimestamp()
        });
      } catch (err) {
        console.warn("Proctor log failed", err.message);
      }
    }

    async function handleCheat(eventType) {
      if (!examStarted || examFinished) return;

      warningCount++;
      updateWarningUI();

      let title = "Security Alert";
      let desc = "Suspicious activity detected.";
      let isFsErr = false;

      if (eventType === "COPY") {
        title = "Copying is Blocked";
        desc = "Keyboard shortcuts (Ctrl+C) and Menu Copy are disabled.";
        await logProctor("COPY", "User tried to copy exam content.");
      } else if (eventType === "TAB") {
        title = "Focus Lost";
        desc = "You switched tabs or minimized the browser.";
        await logProctor("TAB_SWITCH", "User changed tab or window.");
      } else if (eventType === "FULLSCREEN_EXIT") {
        title = "Fullscreen Exited";
        desc = "You must remain in fullscreen mode. Click anywhere to return.";
        isFsErr = true;
        await logProctor("FULLSCREEN_EXIT", "User exited fullscreen.");
      }

      showCenterWarning(title, desc, isFsErr);

      if (warningCount >= MAX_WARNINGS) {
        await finalizeSubmit("AUTO_SUBMITTED");
      }
    }

    // ---------- ANTI-CHEAT EVENTS ----------
    document.addEventListener("copy", (e) => {
      e.preventDefault();
      handleCheat("COPY");
    });
    document.addEventListener("cut", (e) => {
      e.preventDefault();
      handleCheat("COPY");
    });
    document.addEventListener("paste", (e) => {
      e.preventDefault();
    });

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) handleCheat("TAB");
    });
    window.addEventListener("blur", () => {
      handleCheat("TAB");
    });

    document.addEventListener("fullscreenchange", () => {
      if (!document.fullscreenElement && examStarted && !examFinished) {
        handleCheat("FULLSCREEN_EXIT");
      }
    });
    document.addEventListener("webkitfullscreenchange", () => {
      if (!document.webkitFullscreenElement && examStarted && !examFinished) {
        handleCheat("FULLSCREEN_EXIT");
      }
    });

    // ---------- DATA LOADING ----------
    async function loadUser() {
      return new Promise((resolve) => {
        onAuthStateChanged(auth, (u) => {
          if (!u) {
            window.location.href = "index.html";
            resolve(false);
          } else {
            user = u;
            resolve(true);
          }
        });
      });
    }

    async function loadTest() {
      try {
        const docRef = doc(db, "exam_tests", testId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
          console.error("Test not found");
          return;
        }
        testData = { id: docSnap.id, ...docSnap.data() };
        testTitleEl.textContent = testData.title;
        trackBadgeEl.textContent = testData.track_id
          ? `Track: ${testData.track_id}`
          : "Track: —";
      } catch (error) {
        console.error("Test load error:", error);
      }
    }

    async function loadQuestions() {
      try {
        const q = query(collection(db, "exam_questions"), where("test_id", "==", testId));
        const querySnapshot = await getDocs(q);

        // Fetch options for each question manually since we can't join
        let loadedQuestions = [];
        for (const docSnap of querySnapshot.docs) {
          const quest = { id: docSnap.id, ...docSnap.data() };

          // Fetch options for this question
          const optsQ = query(collection(db, "exam_options"), where("question_id", "==", quest.id));
          const optsSnap = await getDocs(optsQ);
          quest.exam_options = optsSnap.docs.map(op => ({ id: op.id, ...op.data() }));

          if (quest.exam_options.length > 0) {
            shuffleArray(quest.exam_options);
          }
          loadedQuestions.push(quest);
        }

        questions = shuffleArray(loadedQuestions);
        totalCounterEl.textContent = questions.length;
      } catch (error) {
        console.error("Question load error:", error);
      }
    }

    // --------- ALWAYS CREATE NEW ATTEMPT (NO REUSE) ----------
    async function loadAttempt() {
      const durationMinutesRaw = testData?.duration_minutes ?? 0;
      const durationMinutes = Math.max(1, durationMinutesRaw); // at least 1 min

      try {
        const attemptRef = await addDoc(collection(db, "exam_attempts"), {
          user_id: user.uid,
          test_id: testId,
          started_at: new Date().toISOString(),
          status: "IN_PROGRESS",
          created_at: serverTimestamp()
        });

        const snap = await getDoc(attemptRef);
        attempt = { id: snap.id, ...snap.data() };

        // If serverTimestamp() hasn't resolved locally yet (latency compensation), use local time
        const startedAt = attempt.started_at ? new Date(attempt.started_at) : new Date();
        deadline = new Date(startedAt.getTime() + durationMinutes * 60000);

      } catch (error) {
        console.error("Attempt insert error:", error);
      }
    }

    async function loadExistingResponses() {
      // New attempt => empty map
      responsesMap = {};
      answeredCounterEl.textContent = 0;
    }

    // ---------- PALETTE ----------
    function createPaletteGrid(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = "";

      questions.forEach((q, idx) => {
        const btn = document.createElement("button");
        btn.id = `${containerId}_btn_${idx}`;
        btn.dataset.index = idx;
        btn.textContent = idx + 1;
        btn.className =
          "h-9 w-9 lg:h-7 lg:w-7 rounded-lg flex items-center justify-center text-xs border border-slate-700 bg-slate-800 hover:bg-slate-700 active:scale-[0.96] transition font-medium";

        btn.addEventListener("click", () => {
          if (!examStarted || examFinished) return;
          currentIndex = idx;
          renderQuestion();
          if (containerId === "mobilePaletteContainer") closeMobileDrawer();
        });
        container.appendChild(btn);
      });
    }

    function renderPalette() {
      createPaletteGrid("paletteContainer");
      createPaletteGrid("mobilePaletteContainer");
      updatePaletteColors();
    }

    function updatePaletteColors() {
      const answeredIds = new Set(
        Object.entries(responsesMap)
          .filter(
            ([, r]) =>
              r &&
              (r.option_id ||
                (r.short_answer && r.short_answer.toString().trim() !== ""))
          )
          .map(([qid]) => qid)
      );

      ["paletteContainer", "mobilePaletteContainer"].forEach((contId) => {
        questions.forEach((q, idx) => {
          const btn = document.getElementById(`${contId}_btn_${idx}`);
          if (!btn) return;
          btn.className =
            "h-9 w-9 lg:h-7 lg:w-7 rounded-lg flex items-center justify-center text-xs border transition font-medium";

          if (idx === currentIndex) {
            btn.classList.add(
              "bg-sky-500/90",
              "border-sky-300",
              "text-white",
              "shadow-k-glow"
            );
          } else if (answeredIds.has(q.id)) {
            btn.classList.add(
              "bg-emerald-500/80",
              "border-emerald-300",
              "text-white"
            );
          } else if (visitedSet.has(q.id)) {
            btn.classList.add(
              "bg-amber-500/80",
              "border-amber-300",
              "text-white"
            );
          } else {
            btn.classList.add(
              "bg-slate-800",
              "border-slate-700",
              "text-slate-400"
            );
          }
        });
      });
    }

    // ---------- QUESTION RENDER ----------
    function renderQuestion() {
      if (!questions.length) return;
      const q = questions[currentIndex];
      visitedSet.add(q.id);

      questionBadgeEl.textContent = `Question ${currentIndex + 1}`;
      questionTitleEl.textContent = q.chapter ? `[${q.chapter}]` : "Question";
      questionTextEl.textContent = q.question_text;
      marksLabelEl.textContent = `${q.marks || 1} mark${(q.marks || 1) > 1 ? "s" : ""
        }`;
      questionProgressEl.textContent = `Question ${currentIndex + 1
        } of ${questions.length}`;
      currentIndexLabel.textContent = `Q ${currentIndex + 1}`;

      if (currentIndex === questions.length - 1) {
        nextBtnText.textContent = "Finish";
        nextBtnIcon.className = "ph ph-check text-xs";
      } else {
        nextBtnText.textContent = "Next";
        nextBtnIcon.className = "ph ph-arrow-right text-xs";
      }

      optionsContainer.innerHTML = "";
      shortContainer.classList.add("hidden");

      const existing = responsesMap[q.id] || {};

      if (q.question_type === "MCQ" || q.question_type === "TF") {
        (q.exam_options || []).forEach((opt) => {
          const btn = document.createElement("button");
          btn.className =
            "w-full text-left text-[13px] px-3.5 py-3 rounded-xl border border-slate-700/80 bg-slate-900/40 hover:bg-slate-800 active:scale-[0.98] transition flex items-start gap-3 group";

          const bullet = document.createElement("div");
          bullet.className =
            "mt-[3px] h-4 w-4 rounded-full border border-slate-500/60 flex items-center justify-center transition-colors";

          const innerDot = document.createElement("div");
          innerDot.className =
            "h-2 w-2 rounded-full bg-transparent transition-colors";
          bullet.appendChild(innerDot);

          const label = document.createElement("div");
          label.className =
            "flex-1 text-slate-300 group-hover:text-slate-100 transition-colors";
          label.textContent = opt.option_text;

          btn.appendChild(bullet);
          btn.appendChild(label);

          if (existing.option_id === opt.id) {
            btn.classList.remove(
              "border-slate-700/80",
              "bg-slate-900/40"
            );
            btn.classList.add(
              "border-emerald-500/60",
              "bg-emerald-500/10",
              "text-emerald-100"
            );
            bullet.classList.add(
              "border-emerald-400",
              "bg-emerald-500/20"
            );
            innerDot.classList.add("bg-emerald-400");
            label.classList.add("text-emerald-50");
          }

          btn.addEventListener("click", () =>
            handleOptionClick(q.id, opt.id)
          );
          optionsContainer.appendChild(btn);
        });
      } else if (q.question_type === "SHORT") {
        shortContainer.classList.remove("hidden");
        shortInput.value = existing.short_answer || "";
      }

      updatePaletteColors();
    }

    async function handleOptionClick(questionId, optionId) {
      if (!examStarted || examFinished) return;
      responsesMap[questionId] = {
        option_id: optionId,
        short_answer: null,
      };
      answeredCounterEl.textContent = countAnswered();
      updatePaletteColors();

      // Upsert response
      // We need to query if response exists for this attempt+question, or use a custom ID structure
      // Composite ID idea: attempt_id + "_" + question_id
      const respId = `${attempt.id}_${questionId}`;
      const payload = {
        attempt_id: attempt.id,
        question_id: questionId,
        option_id: optionId,
        short_answer: null,
        updated_at: serverTimestamp()
      };
      await setDoc(doc(db, "exam_responses", respId), payload, { merge: true });

      renderQuestion();
    }

    let shortSaveTimeout = null;
    shortInput.addEventListener("input", () => {
      if (!examStarted || examFinished) return;
      const q = questions[currentIndex];
      const val = shortInput.value;
      responsesMap[q.id] = { option_id: null, short_answer: val };
      answeredCounterEl.textContent = countAnswered();
      updatePaletteColors();
      if (shortSaveTimeout) clearTimeout(shortSaveTimeout);
      shortSaveTimeout = setTimeout(async () => {
        const respId = `${attempt.id}_${q.id}`;
        const payload = {
          attempt_id: attempt.id,
          question_id: q.id,
          option_id: null,
          short_answer: val,
          updated_at: serverTimestamp()
        };
        await setDoc(doc(db, "exam_responses", respId), payload, { merge: true });
      }, 500);
    });

    // ---------- TIMER (FIXED - RELIABLE) ----------
    function startTimer() {
      // Clear any existing interval first
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      // ALWAYS set deadline from NOW when exam starts if not already set or invalid
      if (!deadline || isNaN(deadline.getTime())) {
        const duration = (testData && testData.duration_minutes) ? testData.duration_minutes : 60;
        const now = new Date();
        deadline = new Date(now.getTime() + duration * 60000);
        console.log("Timer: Deadline set from now - ", deadline.toISOString(), "Duration:", duration, "minutes");
      }

      // Double-check deadline is valid
      if (!deadline || isNaN(deadline.getTime())) {
        console.error("Timer: Failed to set deadline, using 60 min default");
        deadline = new Date(Date.now() + 60 * 60000);
      }

      function tick() {
        if (examFinished) {
          if (timerInterval) clearInterval(timerInterval);
          return;
        }
        const now = new Date();
        let remaining = Math.floor((deadline - now) / 1000);

        // Handle edge case where deadline might be in the past
        if (remaining <= 0) {
          timerDisplay.textContent = "00:00";
          if (timerInterval) clearInterval(timerInterval);
          finalizeSubmit("AUTO_SUBMITTED");
          return;
        }

        if (remaining < 60) {
          timerDisplay.classList.add("text-rose-400", "animate-pulse");
        }
        timerDisplay.textContent = formatTimer(remaining);
      }

      // Execute tick immediately to show time right away
      tick();

      // Start interval - use timeout to ensure it starts
      timerInterval = setInterval(tick, 1000);

      // Log for debugging
      console.log("Timer: Started successfully, interval ID:", timerInterval);
    }

    // ---------- SUBMIT ----------
    function handleSubmitClick() {
      if (!examStarted || examFinished) return;
      showCustomConfirm(
        "Submit Exam?",
        "Are you sure you want to finish the exam?",
        async () => {
          await finalizeSubmit("SUBMITTED");
        }
      );
    }

    submitBtn.addEventListener("click", handleSubmitClick);

    backBtn.addEventListener("click", () => {
      if (!examFinished) {
        showCustomConfirm(
          "Exit Exam?",
          "Timer continues if you leave.",
          () => (window.location.href = "dashboard.html")
        );
      } else {
        window.location.href = "dashboard.html";
      }
    });

    resultBackBtn.addEventListener("click", () => {
      window.location.href = "dashboard.html";
    });
    reviewPageBtn.addEventListener("click", () => {
      if (attempt && attempt.id) {
        window.location.href = `review.html?attempt_id=${attempt.id}`;
      } else {
        alert("Review page not linked yet.");
      }
    });

    // ---------- NAVIGATION ----------
    prevBtn.addEventListener("click", () => {
      if (!examStarted || examFinished) return;
      if (currentIndex > 0) {
        currentIndex--;
        renderQuestion();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (!examStarted || examFinished) return;
      if (currentIndex < questions.length - 1) {
        currentIndex++;
        renderQuestion();
      } else {
        handleSubmitClick();
      }
    });

    // ---------- START EXAM ----------
    startExamBtn.addEventListener("click", async () => {
      try {
        if (!document.fullscreenElement) {
          await document.documentElement.requestFullscreen();
        }
      } catch (e) {
        console.warn("Fullscreen blocked:", e.message);
      }
      startOverlay.classList.add("hidden");
      examStarted = true;
      mobileTriggerApp.classList.remove("hidden");
      updateWarningUI();
      startTimer();
    });

    // ---------- FINALIZE SUBMIT ----------
    async function finalizeSubmit(type = "SUBMITTED") {
      if (examFinished || !attempt) return;
      examFinished = true;
      if (timerInterval) clearInterval(timerInterval);
      mobileTriggerApp.classList.add("hidden");

      let score = 0;
      let correctCount = 0;
      questions.forEach((q) => {
        const resp = responsesMap[q.id];
        if (!resp || !resp.option_id) return;
        const correctOpt = (q.exam_options || []).find((o) => o.is_correct);
        if (correctOpt && correctOpt.id === resp.option_id) {
          score += q.marks || 1;
          correctCount++;
        }
      });

      const totalQuestions = questions.length || 1;
      const accuracy = Math.round((correctCount / totalQuestions) * 100);
      const xpEarned = score; // Fixed: Points = Score obtained

      await updateDoc(doc(db, "exam_attempts", attempt.id), {
        status: type,
        submitted_at: new Date().toISOString(),
        score,
        accuracy,
        xp_earned: xpEarned,
      });

      if (xpEarned > 0) {
        // Query user state
        const qState = query(collection(db, "exam_user_state"), where("user_id", "==", user.uid));
        const stateSnap = await getDocs(qState);
        if (!stateSnap.empty) {
          const stDoc = stateSnap.docs[0];
          await updateDoc(stDoc.ref, {
            total_xp: (stDoc.data().total_xp || 0) + xpEarned,
            total_points: (stDoc.data().total_points || 0) + xpEarned // Sync points
          });
        }
      }

      if (document.fullscreenElement) {
        try {
          await document.exitFullscreen();
        } catch (e) { }
      }

      buildResultUI(score, totalQuestions, accuracy, xpEarned, type);
    }

    function buildResultUI(score, total, accuracy, xpEarned, statusType) {
      const summaryEl = resultSummary;
      summaryEl.innerHTML = `
      <div class="rounded-xl bg-slate-900 border border-slate-700 px-3 py-3 text-center">
        <div class="text-[10px] text-slate-400 uppercase tracking-wide">Score</div>
        <div class="text-2xl font-bold text-white mt-1">${score}<span class="text-base text-slate-500 font-normal">/${total}</span></div>
      </div>
      <div class="rounded-xl bg-slate-900 border border-slate-700 px-3 py-3 text-center">
        <div class="text-[10px] text-slate-400 uppercase tracking-wide">Accuracy</div>
        <div class="text-2xl font-bold ${accuracy >= 70 ? "text-emerald-400" : "text-amber-400"
        } mt-1">${accuracy}%</div>
      </div>
      <div class="rounded-xl bg-slate-900 border border-slate-700 px-3 py-3 text-center">
        <div class="text-[10px] text-slate-400 uppercase tracking-wide">Points Earned</div>
        <div class="text-2xl font-bold text-sky-400 mt-1">+${xpEarned}</div>
      </div>
      <div class="rounded-xl bg-slate-900 border border-slate-700 px-3 py-3 text-center">
        <div class="text-[10px] text-slate-400 uppercase tracking-wide">Status</div>
        <div class="text-xs font-bold mt-2 uppercase tracking-wider ${statusType === "AUTO_SUBMITTED"
          ? "text-rose-400"
          : "text-emerald-400"
        }">${statusType.replace("_", " ")}</div>
      </div>
    `;

      resultOverlay.classList.remove("hidden");
      const root = resultOverlay.firstElementChild;
      if (root) {
        gsap.fromTo(
          root,
          { opacity: 0, scale: 0.9 },
          { opacity: 1, scale: 1, duration: 0.25, ease: "power2.out" }
        );
      }
    }

    // ---------- INIT ----------
    (async function init() {
      testId = getParam("test_id");
      if (!testId) {
        console.error("Missing test_id");
        return;
      }
      const authorized = await loadUser();
      if (!authorized) return;

      await loadTest();
      await loadQuestions();
      await loadAttempt();          // ALWAYS new attempt
      await loadExistingResponses(); // normally empty for new attempt
      renderPalette();
      renderQuestion();
      answeredCounterEl.textContent = countAnswered();
      updateWarningUI();
    })();
  </script>
</body>

</html>