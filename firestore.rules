rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== HELPER FUNCTIONS =====
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'piyushkundu99@gmail.com';
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // ===== USER DATA (Users can read/write their own) =====
    
    // PROFILES: Public read, users write their own, admin writes all
    match /profiles/{userId} {
      allow read: if true;
      allow write: if isAdmin() || isOwner(userId);
    }
    
    // USER SETTINGS: Only owner or admin
    match /user_settings/{userId} {
      allow read, write: if isAdmin() || isOwner(userId);
    }
    
    // ===== EXAM SYSTEM (Users need to save answers & scores) =====
    
    // EXAM USER STATE: Users can create and modify their own exam progress
    match /exam_user_state/{stateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() || 
        (isAuthenticated() && resource.data.user_id == request.auth.uid);
    }
    
    // TESTS: Everyone reads, only admin creates/edits tests
    match /tests/{testId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // LEADERBOARD: Public read, users write their own entries, admin writes all
    match /leaderboard/{entryId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAdmin() || 
        (isAuthenticated() && resource.data.user_id == request.auth.uid);
      allow delete: if isAdmin();
    }
    
    // ===== CONTENT (Admin manages, users read) =====
    
    // VIDEOS: Public read, admin writes
    match /videos/{videoId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // BADGES: Public read, admin writes
    match /badges/{badgeId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // LEVELS: Public read, admin writes
    match /levels/{levelId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // NOTIFICATIONS: Authenticated read, admin writes
    match /notifications/{notifId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ===== APPS (Users can add their own, admin manages global) =====
    
    // APPS: Users read all, create their own, edit/delete their own
    match /apps/{appId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() || 
        (isAuthenticated() && resource.data.user_id == request.auth.uid);
    }
    
    // GLOBAL APPS: Public read, admin writes
    match /global_apps/{appId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ===== CATCH-ALL (Authenticated read, admin write) =====
    match /{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
